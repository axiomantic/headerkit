name: Check LLVM Releases

# Detect new stable LLVM major versions that aren't yet vendored in headerkit/_clang/.
# Automatically vendor if possible, falling back to opening an issue for failures.

on:
  schedule:
    - cron: "0 10 * * 1" # Mondays at 10 AM UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Generate app token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.AXIOMANTIC_APP_ID }}
          private-key: ${{ secrets.AXIOMANTIC_PRIVATE_KEY }}

      - uses: actions/checkout@v6
        with:
          token: ${{ steps.app-token.outputs.token }}

      - name: Detect new LLVM versions
        id: detect
        run: |
          # Fetch all LLVM tags once and cache for reuse
          all_tags=$(
            git -c 'versionsort.suffix=-' \
              ls-remote --exit-code --refs --sort='version:refname' --tags \
              https://github.com/llvm/llvm-project 'llvmorg-*.*.*' \
            | sed 's/.*llvmorg-//' \
            | grep -v '-'
          )

          # Get all stable LLVM major versions with releases (>= 18)
          released_majors=$(
            echo "$all_tags" \
            | awk -F. '$1 >= 18 { print $1 }' \
            | sort -un
          )

          # Get vendored major versions
          vendored_majors=$(
            ls -d headerkit/_clang/v*/ 2>/dev/null \
            | sed 's|headerkit/_clang/v||; s|/||' \
            | sort -n
          )

          echo "Released LLVM majors: $released_majors"
          echo "Vendored majors: $vendored_majors"

          # Find missing versions
          missing=""
          for major in $released_majors; do
            if ! echo "$vendored_majors" | grep -qx "$major"; then
              missing="$missing $major"
            fi
          done
          missing=$(echo "$missing" | xargs)

          echo "Missing: ${missing:-none}"
          echo "missing=$missing" >> "$GITHUB_OUTPUT"

          # Save tag list for reuse in later steps
          {
            echo "all_tags<<TAGS_EOF"
            echo "$all_tags"
            echo "TAGS_EOF"
          } >> "$GITHUB_OUTPUT"

      - uses: actions/setup-python@v6
        if: steps.detect.outputs.missing != ''
        with:
          python-version: "3.12"

      - name: Attempt auto-vendor
        id: vendor
        if: steps.detect.outputs.missing != ''
        env:
          MISSING: ${{ steps.detect.outputs.missing }}
          ALL_TAGS: ${{ steps.detect.outputs.all_tags }}
        run: |
          vendored=""
          failed=""

          for major in $MISSING; do
            # Get latest patch version for this major from cached tags
            latest=$(
              echo "$ALL_TAGS" \
              | grep "^${major}\." \
              | sort -t. -k1,1n -k2,2n -k3,3n \
              | tail -1
            )

            echo "Attempting to vendor LLVM $major (tag: $latest)..."
            if python scripts/vendor_clang.py "$major" "$latest"; then
              echo "Successfully vendored LLVM $major"
              vendored="$vendored $major"
            else
              echo "Failed to vendor LLVM $major"
              failed="$failed $major"
            fi
          done

          vendored=$(echo "$vendored" | xargs)
          failed=$(echo "$failed" | xargs)

          echo "Vendored: ${vendored:-none}"
          echo "Failed: ${failed:-none}"
          echo "vendored=$vendored" >> "$GITHUB_OUTPUT"
          echo "failed=$failed" >> "$GITHUB_OUTPUT"

      - name: Create pull request for vendored versions
        if: steps.vendor.outputs.vendored != ''
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.app-token.outputs.token }}
          commit-message: "Vendor clang bindings for LLVM ${{ steps.vendor.outputs.vendored }}"
          title: "Vendor clang bindings for LLVM ${{ steps.vendor.outputs.vendored }}"
          body: |
            Automatically vendored clang Python bindings for new LLVM version(s): ${{ steps.vendor.outputs.vendored }}.

            Run the test suite locally to verify:
            ```
            pytest
            ```
          branch: auto/vendor-llvm
          delete-branch: true

      - name: Open issues for failed versions
        if: steps.vendor.outputs.failed != ''
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          FAILED: ${{ steps.vendor.outputs.failed }}
          ALL_TAGS: ${{ steps.detect.outputs.all_tags }}
        run: |
          for major in $FAILED; do
            title="Vendor clang Python bindings for LLVM $major"

            # Skip if issue already exists (open or closed)
            existing=$(gh issue list --search "\"$title\" in:title" --state all --json number --jq 'length')
            if [ "$existing" -gt 0 ]; then
              echo "Issue already exists for LLVM $major, skipping"
              continue
            fi

            # Get latest patch version for this major from cached tags
            latest=$(
              echo "$ALL_TAGS" \
              | grep "^${major}\." \
              | sort -t. -k1,1n -k2,2n -k3,3n \
              | tail -1
            )

            body="A new LLVM major version ($major) has stable releases (latest: $latest) but no vendored bindings in \`headerkit/_clang/\`.

          Auto-vendoring was attempted but failed. Manual vendoring is required.

          ## Steps to vendor

          1. Download the clang Python bindings from the LLVM $latest source:
             \`\`\`
             https://github.com/llvm/llvm-project/tree/llvmorg-$latest/clang/bindings/python/clang
             \`\`\`
          2. Create \`headerkit/_clang/v$major/\` with:
             - \`__init__.py\`
             - \`cindex.py\` (from the LLVM source)
             - \`PROVENANCE\` (source URL, SHA256, license)
          3. Update \`headerkit/_clang/__init__.py\` if the loader needs changes for the new version.
          4. Add tests and verify with \`pytest\`.

          *This issue was automatically created by the check-llvm workflow.*"

            gh issue create --title "$title" --body "$body"
            echo "Created issue for LLVM $major"
          done
