name: Test install_libclang

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  install-libclang:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.10"
          cache: 'pip'

      - name: Install package
        shell: bash
        run: pip install -e .

      - name: Run install_libclang
        shell: bash
        run: |
          if [ "$RUNNER_OS" = "Linux" ]; then
            sudo python -m headerkit.install_libclang --skip-verify
          else
            python -m headerkit.install_libclang --skip-verify
          fi

      - name: Refresh PATH (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $machinePath = [Environment]::GetEnvironmentVariable("Path", "Machine")
          $userPath = [Environment]::GetEnvironmentVariable("Path", "User")
          $env:Path = "$machinePath;$userPath"
          echo "Path=$env:Path" >> $env:GITHUB_ENV

      - name: Verify libclang is usable
        shell: bash
        run: python -c "from headerkit.backends.libclang import is_system_libclang_available; assert is_system_libclang_available(), 'libclang not available after install'"
